 <!DOCTYPE html>
 <html>
   <head>

     <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>

     <meta charset="utf-8">
     <meta name="viewport" content="width=device-width, initial-scale=1">

     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.4/semantic.min.css" type="text/css">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/solarized-light.min.css" rel="stylesheet" />

     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.address/1.6/jquery.address.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.4/semantic.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
     <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/languages/java.min.js"></script>
     <script>hljs.initHighlightingOnLoad();</script>

      <style>
        

body 
{
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
}

figcaption
{
  margin-bottom: 20px;
}

.vertical-align
{
  display: flex;
  align-items: center;
}



    </style>

  </head>

  <body>
    

<style>
  

code
{
  font-family: "Monaco";
  font-size: 110%;
}

img
{
  padding:1px;
  border:1px solid black;
}

h1
{
  font-style:italic;
  font-size:130%;
  border-bottom: thin solid black;
}
h2
{
  font-size:110%;
  border-bottom: thin solid black;
}
h3
{
  font-size:100%;
  border-bottom: thin solid black;
}



</style>

<div class="ui fixed top pointing inverted menu labmenu">
  <header class="header item">
    <i id="toc" class="sitemap icon"></i>
    <a href="../index.html">
      4: Google Services
    </a>
  </header>
  <div class="right tab-menu menu">
    
    <a class="item" data-tab="Lab-08">
      Lab-08
    </a>
    
    <a class="item" data-tab="01">
      01
    </a>
    
    <a class="item" data-tab="02">
      02
    </a>
    
    <a class="item" data-tab="03">
      03
    </a>
    
    <a class="item" data-tab="04">
      04
    </a>
    
    <a class="item" data-tab="05">
      05
    </a>
    
    <a class="item" data-tab="06">
      06
    </a>
    
    <a class="item" data-tab="07">
      07
    </a>
    
    <a class="item" data-tab="08">
      08
    </a>
    
    <a class="item" data-tab="Solution">
      Solution
    </a>
    
    <a class="item" data-tab=".">
      .
    </a>
    
    <a class="item" href="../../index.html">
      <i class="home icon"></i>
    </a>
  </div>
</div>

<div class="ui segment pushable">
  <div class="ui inverted labeled icon left inline vertical sidebar menu">
    
      
        <a class="item" href="../../topic01-overview-and-tools/book-a-lab-01/index.html">
          Lab-01
        </a>
      
    
      
        <a class="item" href="../../topic01-overview-and-tools/book-coffeemate-lab-01/index.html">
          Lab-02
        </a>
      
    
      
        <a class="item" href="../../topic02-ui-design/book-coffeemate-lab-02/index.html">
          Lab-03
        </a>
      
    
      
        <a class="item" href="../../topic02-ui-design/book-coffeemate-lab-03/index.html">
          Lab-04
        </a>
      
    
      
        <a class="item" href="../../topic03-networking/book-coffeemate-lab-04/index.html">
          Lab-05
        </a>
      
    
      
        <a class="item" href="../../topic04-google-services/book-coffeemate-lab-05/index.html">
          Lab-06
        </a>
      
    
      
        <a class="item" href="../../topic04-google-services/book-coffeemate-lab-06/index.html">
          Lab-07
        </a>
      
    
      
        <a class="active item" href="../../topic04-google-services/book-coffeemate-lab-07/index.html">
          Lab-08
        </a>
      
    
  </div>
  <div class="pusher">
    <div class="ui basic segment">
      <br>
      
      <div  class="ui tab segment lab" data-tab="Lab-08">
        <h1>Objectives</h1>
<p>This lab &#39;takes a big step forward&#39;, in that we refactor the previous version (6.0) of our Case Study <b>CoffeeMate</b> and introduce <strong>Firebase Support</strong> via <strong>Google Authentication</strong> and a <strong>Realtime Database</strong> in version <b>CoffeeMateFBI.1.0</b></p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="01">
        <h1>Setup - Starter Code</h1>
<p>It can be quite difficult to try and &#39;bolt on&#39; Firebase to an Android App, depending on the number and type of APis being used, but we can start with a version which does include a number of the Google APis that we need, namely <b>CoffeeMate.6.0</b>, which you can download here - <a href="archives/CoffeeMate.6.0.zip">CoffeeMate.6.0</a>.</p>
<p>As always, It&#39;s probably still a good idea to run the App and confirm that the app (or your 6.0 version app) is configured properly and (still) running.</p>
<p>You might also want to rename the app to what I will be referring to throughout the rest of the lab - <b>CoffeeMateFBI.1.0</b>.</p>
<p>On completion of this lab, you will be able to do the following:</p>
<ul>
<li><p>Create/Import a new project to your Firebase Console (found <a href="https://console.firebase.google.com">here</a>) and configure your project as required</p>
</li>
<li><p>Add Firebase Authentication (including Google Sign-In)</p>
</li>
<li><p>Add CRUD (Create Retrieve Update Delete) functionality via your Firebase Realtime Database</p>
</li>
</ul>
<p>The following steps will help you achieve this, so before we can do anything with Firebase, let&#39;s setup our CoffeeMate Project on the Firebase Console.</p>
<p>The instructions on the official developer docs are as good a place to start as any, so check how to &#39;Add Firebase to your Project&#39; <a href="https://firebase.google.com/docs/android/setup">here</a>.</p>
<p>The final list of dependencies/plugins required are as below, so confirm your list against mine and add them in at this stage if you so wish?</p>
<pre><code>dependencies {
    compile fileTree(include: [&#39;*.jar&#39;], dir: &#39;libs&#39;)
    compile project(&#39;:volley&#39;)
    compile &#39;com.android.support:appcompat-v7:25.2.0&#39;
    compile &#39;com.android.support:support-v4:25.2.0&#39;
    compile &#39;com.android.support:design:25.2.0&#39;
    compile &#39;com.makeramen:roundedimageview:2.2.1&#39;
    compile &#39;com.android.support.constraint:constraint-layout:1.0.2&#39;
    compile &#39;com.google.code.gson:gson:2.7&#39;
    compile &#39;com.google.android.gms:play-services-auth:11.0.2&#39;
    compile &#39;com.google.android.gms:play-services-maps:11.0.2&#39;
    compile &#39;com.google.android.gms:play-services-location:11.0.2&#39;

    compile &#39;com.google.firebase:firebase-core:11.0.2&#39;
    compile &#39;com.google.firebase:firebase-auth:11.0.2&#39;
    compile &#39;com.google.firebase:firebase-database:11.0.2&#39;
    compile &#39;com.firebaseui:firebase-ui-database:1.0.0&#39;
    testCompile &#39;junit:junit:4.12&#39;
}

apply plugin: &#39;com.google.gms.google-services&#39;</code></pre>
<p>Once you have your project set up, you can continue on to the next step.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="02">
        <h1>Signing In with Firebase Authentication</h1>
<p>First of all, make sure you have your Firebase Project set up and you&#39;ve added your existing CoffeeMate project to it, like so</p>
<p><img src="img/labfb01.png" alt=""></p>
<p>Notice I&#39;ve renamed the package to <strong>ie.cmfbi</strong> - there were a few issues when I initially set up the project with the existing <strong>ie.cm</strong> package name (which you might get too) like</p>
<p><img src="img/labfb02.png" alt=""></p>
<p>so I just decided to rename the package. If you take this approach make sure you update your Google Maps APi authorised package name and SHA-1 key on the developer console here <a href="https://console.developers.google.com">https://console.developers.google.com</a></p>
<p>Also, you&#39;ll need an updated <strong>google-services.json</strong> file so make sure you download it during the setup process</p>
<p><img src="img/labfb03.png" alt=""></p>
<p>and</p>
<p><img src="img/labfb04.png" alt=""></p>
<p>Some other useful links</p>
<p><a href="https://console.cloud.google.com/home/dashboard">https://console.cloud.google.com/home/dashboard</a></p>
<p><a href="https://developers.google.com/mobile/add">https://developers.google.com/mobile/add</a></p>
<p>For this Lab we&#39;ll be using Google Sign-In Authentication with Firebase, so visit your firebase console again here <a href="https://console.firebase.google.com">https://console.firebase.google.com</a> and turn on the required Authentication.</p>
<p> <img src="img/labfb05.png" alt=""></p>
<p> We&#39;ll be using a lot of this <a href="https://firebase.google.com/docs/auth/android/google-signin">https://firebase.google.com/docs/auth/android/google-signin</a> for reference on this step.</p>
<p>Now, open your <strong>Login.java</strong> and update your <strong>GoogleSignInOptions</strong> object to &#39;requestIDToken()&#39; like so</p>
<pre><code class="lang-java">app.mGoogleSignInOptions = new GoogleSignInOptions
                .Builder(GoogleSignInOptions.DEFAULT_SIGN_IN)
                .requestIdToken(getString(R.string.default_web_client_id))
                .requestEmail()
                .requestProfile()
                .build();</code></pre>
<p>Next, and the following property to your <strong>CoffeeMateApp</strong></p>
<pre><code class="lang-java">public FirebaseAuth mFirebaseAuth;
public FirebaseUser mFirebaseUser;</code></pre>
<p>and bring in and/or update the following</p>
<pre><code class="lang-java">private void firebaseAuthWithGoogle(GoogleSignInAccount acct) {

       Log.v(TAG, &quot;firebaseAuthWithGoogle:&quot; + acct.getId());

       AuthCredential credential = GoogleAuthProvider.getCredential(acct.getIdToken(), null);
       app.mFirebaseAuth.signInWithCredential(credential)
               .addOnCompleteListener(this, new OnCompleteListener&lt;AuthResult&gt;() {
                   @Override
                   public void onComplete(@NonNull Task&lt;AuthResult&gt; task) {
                       Log.v(TAG, &quot;signInWithCredential:onComplete:&quot; + task.isSuccessful());
                       validateFirebaseUser();
                       // If sign in fails, display a message to the user. If sign in succeeds
                       // the auth state listener will be notified and logic to handle the
                       // signed in user can be handled in the listener.
                       if (!task.isSuccessful()) {
                           Log.v(TAG, &quot;signInWithCredential&quot;, task.getException());
                           Toast.makeText(Login.this, &quot;Authentication failed.&quot;,
                                   Toast.LENGTH_SHORT).show();
                       }
                       else
                           startHomeScreen();
                   }
               });
   }

    private void validateFirebaseUser()
    {
        Log.v(TAG,&quot;Calling validateFirebaseUser() &quot; );
        if(app.mFirebaseUser == null)
            app.mFirebaseUser = FirebaseAuth.getInstance().getCurrentUser();

        final String userName = app.mFirebaseUser.getDisplayName();
        final String userId = app.mFirebaseUser.getUid();
        final String email = app.mFirebaseUser.getEmail();

        Log.v(TAG,&quot;Validating Firebase User Details for: &quot; + app.mFirebaseUser.getEmail());

    }</code></pre>
<p>Add this to your <strong>onCreate()</strong></p>
<pre><code class="lang-java">app.mFirebaseAuth = FirebaseAuth.getInstance();</code></pre>
<p>and try and work out where you should be calling</p>
<pre><code class="lang-java">firebaseAuthWithGoogle(...)</code></pre>
<p>Run your app and keep track of the Logs in Android Studio to verify Firebase Authentication.</p>
<p>If everything is configured correctly, you should now be seeing a new user on your console</p>
<p> <img src="img/labfb06.png" alt=""></p>
<p> and going forward</p>
<p>  <img src="img/labfb06a.png" alt=""></p>
<p>And for completeness you should probably sign out your current user from Firebase, whenever they log out of the app using</p>
<pre><code class="lang-java">FirebaseAuth.getInstance().signOut();
app.mFirebaseUser = null;
Log.v(&quot;coffeemate&quot;, &quot;User Logged out of Firebase&quot;);</code></pre>
<p>The next step will involving Adding coffees to our Firebase Realtime database.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="03">
        <h1>Firebase CRUD - Add a Coffee</h1>
<p>Before you go any further, here&#39;s where we&#39;re at so far</p>
<ul>
<li><a href="archives/CoffeeMateFBI.1.0.sofar.zip">CoffeeMateFBI.1.0.sofar</a></li>
</ul>
<p>and remember to retain your own <strong>google-services.json</strong> file (as this archive doesn&#39;t contain one!).</p>
<p>We&#39;ll be using some of this <a href="http://www.amalhichri.net/android-firebase-realtime-database-basic-cruds/">http://www.amalhichri.net/android-firebase-realtime-database-basic-cruds/</a> tutorial for this and subsequent steps.</p>
<p>So based on the above link, go ahead and add &quot;Firebase offline Persistence&quot;, wherever you think is most appropriate.</p>
<p>Next, add the following to your <strong>CoffeeMateApp</strong></p>
<pre><code class="lang-java">public DatabaseReference mFBDatabase;</code></pre>
<p>Now, in order to perform any operation on the database, whether it be read or write (or update or delete), you need to get a reference to the database first.
the code that follows gives you a reference to the database JSON top node (and a lot more). From here you need to use the child node names to traverse further. And to keep our code as reusable as possible, we&#39;ll introduce a few new classes to manage our Firebase database calls (similar to what we did for our SQLite calls).</p>
<p>First, introduce the following into your <strong>models</strong> package, so that we can associate specific users with their own coffees.</p>
<pre><code class="lang-java">public class User {

    public String userId;
    public String userName;
    public String userEmail;
    public String userProfilePic;

    public User(){
        // Default constructor required for calls to DataSnapshot.getValue(User.class)
    }

    public User(String userId, String userName, String userEmail, String userProfilePic ){
        this.userId = userId;
        this.userName = userName;
        this.userEmail = userEmail;
        this.userProfilePic = userProfilePic;
    }
}</code></pre>
<p>Now, create a new class called <strong>FBDBManager</strong> and for simplicity, place it in the same api package we have our <strong>VolleyApi</strong> class.</p>
<p>add the following properties</p>
<pre><code class="lang-java">  private static final String TAG = &quot;coffeemate&quot;;
  public DatabaseReference mFirebaseDatabase;
  public String mFBUserId;</code></pre>
<p>and methods (for the moment)</p>
<pre><code class="lang-java">public void open() {
      //Set up local caching
      FirebaseDatabase.getInstance().setPersistenceEnabled(true);

      //Bind to remote Firebase Database
      mFirebaseDatabase = FirebaseDatabase.getInstance().getReference();
      Log.v(TAG, &quot;Database Connected :&quot; + mFirebaseDatabase.getKey());
  }
//Check to see if the Firebase User exists in the Database
//if not, create a new User
  public void checkUser(final String userid,final String username,final String email) {
      mFirebaseDatabase.child(&quot;users&quot;).child(userid).addListenerForSingleValueEvent(
              new ValueEventListener() {
                  @Override
                  public void onDataChange(DataSnapshot dataSnapshot) {
                      if(dataSnapshot.exists()){
                          Log.v(TAG, &quot;User found&quot;);
                      }
                      else{
                          Log.v(TAG, &quot;User not found&quot;);
                          User newUser = new User(userid, username, email, null);
                          mFirebaseDatabase.child(&quot;users&quot;).child(userid).setValue(newUser);
                      }
                      mFBUserId = userid;
                      Log.v(TAG, &quot;Firebase User ID : &quot; + mFBUserId);
                  }

                  @Override
                  public void onCancelled(DatabaseError databaseError) {
                      Log.v(TAG, &quot;Unable to Validate Existing Firebase User: &quot;);
                  }
              }
      );
  }</code></pre>
<p>and see if you can make the necessary modifications to the project to</p>
<ul>
<li>open the database &#39;link&#39; to Firebase on App Startup and</li>
<li>verify the currently signed-in user against the database</li>
</ul>
<p>If it all checks out you should see something like this</p>
<p>Initially, with no users</p>
<p> <img src="img/labfb07.png" alt=""></p>
<p> then with one new user (me :-) )</p>
<p>  <img src="img/labfb08.png" alt=""></p>
<p>  etc. etc.</p>
<p>   <img src="img/labfb09.png" alt=""></p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="04">
        <h1>View Users Current Location - Part II</h1>
<p>The previous step was mostly about adding in a lot of boilerplate code to our Fragment, to get things moving - a lot of which you would have seen in the lecture material that covers Location and Google Maps.</p>
<p>This step adds a bit more of that, but also adds some bespoke code specific to CoffeeMate and its features.</p>
<p>Firstly, edit your <b>MapsFragment</b> and add/replace the following methods</p>
<pre><code class="lang-java">protected void startLocationUpdates() {
    mLocationRequest = new LocationRequest();
    mLocationRequest.setPriority(LocationRequest.PRIORITY_BALANCED_POWER_ACCURACY);
    mLocationRequest.setInterval(UPDATE_INTERVAL);
    mLocationRequest.setFastestInterval(FASTEST_INTERVAL);

    try {
        LocationServices.FusedLocationApi.requestLocationUpdates(mGoogleApiClient, mLocationRequest, this);
    }
    catch(SecurityException se) {
        Toast.makeText(getActivity(),&quot;Check Your Permissions on Location Updates&quot;,Toast.LENGTH_SHORT).show();
    }
  }

public void onLocationChanged(Location location) {
// Report to the UI that the location was updated
String msg = &quot;Updated Location: &quot; + Double.toString(location.getLatitude()) + &quot;,&quot; + Double.toString(location.getLongitude());
Log.v(&quot;coffeemate&quot;, &quot;onLocationChanged() = &quot; + msg);
mCurrentLocation = location; initCamera(mCurrentLocation);
}</code></pre>
<p>And make sure you call startLocationUpdates() in your onConnected()</p>
<p>Now, add the following permission to your manifest file</p>
<pre><code class="lang-java">&lt;uses-permission android:name=&quot;android.permission.ACCESS_FINE_LOCATION&quot;/&gt;</code></pre>
<p>and run your app again (and remember to accept these new permissions).</p>
<p><img src="img/lab0710.png" alt=""></p>
<p>You should now see something like this when you &#39;View on Map&#39;</p>
<p><img src="img/lab0706.png" alt=""></p>
<p>but now when you send new coordinates to the emulator, you should see the &#39;blue dot&#39; move to that new location, as below</p>
<p><img src="img/lab0709.png" alt=""></p>
<p><img src="img/lab0707.png" alt=""></p>
<p><img src="img/lab0708.png" alt=""></p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="05">
        <h1>View Users Coffee Locations</h1>
<p>The last step in this lab involves displaying the users coffees on the map, along with the users location (which was the last step) so we need to modify a few classes here, namely</p>
<ul>
<li>MapFragment</li>
<li>AddFragment</li>
<li>CoffeeApi</li>
</ul>
<h3>MapFragment</h3>
<p>Here we need to inspect our list of coffees and (using the longitude and latitude coordinates) place a marker on the map indicating the location of each coffee.</p>
<p>So, first, open up your MapFragment class and add the following method</p>
<pre><code class="lang-java">public void addCoffees(List&lt;Coffee&gt; list){
    for(Coffee c : list)
        getMap().addMarker(new MarkerOptions()
            .position(new LatLng(c.marker.coords.latitude, c.marker.coords.longitude))
            .title(c.name + &quot; €&quot; + c.price)
            .snippet(c.shop + &quot; &quot; + c.address)                 
            .icon(BitmapDescriptorFactory.fromResource(R.drawable.coffee)));
}</code></pre>
<p>To ensure our list of coffees is up to date and the most recent one, the MapFragment class needs to implement the VolleyListener interface, so go ahead and complete that now.</p>
<p>Once you&#39;ve implemented the necessary methods, add a call to <strong><em>addCoffees()</em></strong> in your <strong><em>setList()</em></strong> method.</p>
<p>Now, add the following APi call to your <strong><em>onConnected()</em></strong>  </p>
<pre><code class="lang-java">CoffeeApi.attachListener(this);
CoffeeApi.getAll(&quot;/coffees/&quot; + Base.googleToken, null);</code></pre>
<p>Because we&#39;re passing &#39;null&#39; to our getAll() call, there&#39;s a small change you need to make in your CoffeeApi class - so see if you can work out what it is?</p>
<p>Once you have, add this to your <strong><em>onStop()</em></strong></p>
<pre><code class="lang-java">CoffeeApi.detachListener();</code></pre>
<p>Before you run your app, I&#39;d suggest checking the Web App to confirm you have some coffees stored on the server and can view them on the Map in the Browser, so when you run your app, you know it&#39;s working correctly if you see your coffees - something like this</p>
<p><img src="img/coffeemate.9.png" alt=""></p>
<hr>
<h3>AddFragment</h3>
<p>Now that we can see existing coffees on our Map, what about when we add new coffees on the device, not the web app? This is the final step in our Case Study and involves a bit of work in refactoring our AddFragment as we need to grab the current location to save with our coffee details.</p>
<p>And for fun :) we&#39;ll also embed our MapFragment inside the AddFragment layout, so we can see where we&#39;re adding our coffee, like so</p>
<p><img src="img/coffeemate.10.png" alt=""></p>
<p>First thing to do is</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="06">
        <p>.
.
.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="07">
        <p>.
.
.
.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="08">
        <p>.
.
.
.</p>

      </div>
     
      <div  class="ui tab segment lab" data-tab="Solution">
        <h1>Solution</h1>
<p>This is a solution to the lab:</p>
<ul>
<li><a href="archives/CoffeeMate.6.0.Solution.zip">CoffeeMate.6.0.Solution</a></li>
</ul>

      </div>
     
      <div  class="ui tab segment lab" data-tab=".">
        
      </div>
     
    </div>
  </div>
</div>
  <div class="ui bottom fixed borderless right menu">
    <div class="ui right tiny menu">
      <div class="ui mini message segment">
        David Drohan (ddrohan@wit.ie), Eamonn de Leastar (edeleastar@tssg.wit.ie) & John Fitzgerald (johnjfitzgerald@outlook.com).
        <a  href="http://creativecommons.org/licenses/by-nc/4.0/" title="External link to http://creativecommons.org/licenses/by-nc/4.0/"
            target="_blank">Creative Commons License
        </a>
      </div>
    </div>
  </div>

    <footer>

    </footer>
    <script>
      
$(document).ready(function()
{
  $("img").addClass ("ui image");
  $('.ui.embed').embed();

  var images = $(".lab img");
  jQuery.each(images, function(i)  {
    if((images[i].alt).length > 0)
    {
      var div_img = $(document.createElement("div")).addClass("ui segment");
      $(images[i]).wrap(div_img);
      var div_label = $(document.createElement("div")).addClass("ui ribbon teal top attached label");
      div_label.append(images[i].alt);
      $(div_label).insertBefore(images[i]);
    }
  });


  $('.ui.menu .item')
      .tab({
        history: true,
        historyType: 'hash',
      });

  $('.popup').popup();

  $('.ui.sidebar')
      .sidebar({ context: $('.pushable') })
      .sidebar('setting', 'transition', 'slide out')
      .sidebar('attach events', '#toc');
});

    </script>
  </body>

 </html>